
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>AI Interview</title>
</head>
<body>
  <div class="loading-screen" *ngIf="isLoadingSession" role="alert" aria-live="polite">
    <mat-spinner aria-label="Loading interview session"></mat-spinner>
    <h1 class="loading-title">Starting Your Interview...</h1>
    <p>Please wait while we set things up.</p>
  </div>

 <div class="interview-main animated-panel" [hidden]="isLoadingSession" role="main">
    <div class="ai-panel" role="region" aria-label="AI Interviewer Panel">
      <div class="ai-voice-section">
        <h3><mat-icon>record_voice_over</mat-icon> AI Interviewer Voice</h3>
        <div class="ai-interviewer-video-container">
          <video class="ai-interviewer-video" autoplay loop muted playsinline [ngClass]="{'speaking': isAiSpeaking}" aria-label="Animated AI interviewer">
            <source src="assets/ai-interviewer.webm" type="video/webm">
            <img src="assets/ai-interviewer-fallback.jpg" alt="AI interviewer fallback image">
          </video>
          <div class="ai-speaking-overlay" [ngClass]="{'show': isAiSpeaking}" aria-hidden="true">
            <mat-icon>graphic_eq</mat-icon> AI is speaking...
          </div>
        </div>
        <p class="current-ai-question" [innerHTML]="currentQuestion.questionName"></p>
      </div>

      <div class="ai-chat-history-full">
        <h4><mat-icon>chat_bubble_outline</mat-icon> AI Conversation History</h4>
        <div class="chat-messages" role="log" aria-live="polite">
          <div *ngFor="let chat of fullChatHistory" class="chat-message" [ngClass]="{'ai-message': chat.sender === 'ai', 'user-message': chat.sender === 'user'}">
            <p><strong>{{ chat.sender === 'user' ? 'You' : 'AI' }}:</strong> {{ chat.text }}</p>
          </div>
          <div class="no-messages" *ngIf="fullChatHistory.length === 0">
            No AI conversation yet.
          </div>
        </div>
        <mat-form-field class="ai-chat-input">
          <mat-label>Ask AI Assistant</mat-label>
          <input matInput [(ngModel)]="userQuery" (keyup.enter)="askAssistant()" aria-label="Ask AI assistant">
        </mat-form-field>
      </div>
    </div>

    <div class="question-panel animated-panel" role="region" aria-label="Question Panel">
      <div class="question-header">
        <h2 class="question-title">{{ currentQuestion.questionName }}</h2>
        <button mat-icon-button (click)="getHelp('general')" aria-label="Get help for current question">
          <mat-icon>help_outline</mat-icon>
        </button>
      </div>
      <mat-form-field appearance="outline" class="answer-field">
        <mat-label>Your Answer</mat-label>
        <textarea matInput [(ngModel)]="currentLiveTranscript" placeholder="Speak or type your response..." aria-label="Enter or speak your answer"></textarea>
        <mat-icon matSuffix class="listening-indicator" *ngIf="isListening">mic</mat-icon>
        <mat-hint *ngIf="isListening">Listening for your response...</mat-hint>
      </mat-form-field>
    
      <div class="nudge-message" *ngIf="motivationalNudge">
        <mat-icon>sentiment_satisfied_alt</mat-icon> {{ motivationalNudge }}
      </div>
      <div class="realtime-feedback">
        <h4><mat-icon>insights</mat-icon> Real-time Feedback</h4>
        <mat-chip-listbox aria-label="Real-time feedback metrics">
          <mat-chip color="primary" selectable="true">{{ speakingRateFeedback }}</mat-chip>
          <mat-chip color="accent" selectable="true">{{ fillerWordFeedback }}</mat-chip>
        </mat-chip-listbox>
      </div>
    </div>

    <div class="candidate-info-panel animated-panel" role="region" aria-label="Candidate Information Panel">
      <div class="profile-section">
        <div class="avatar-wrapper">
          <img class="candidate-avatar" [src]="candidateAvatarUrl" alt="Candidate avatar">
          <span class="online-indicator" [ngClass]="{'online': isUserOnline}" aria-hidden="true"></span>
        </div>
        <h2 class="candidate-name">{{ candidateName }}</h2>
        <p class="role-info">{{ companyName }} â€” {{ roundName }}</p>
      </div>
      <div class="video-container">
        <video class="video-preview" #videoPlayer autoplay playsinline aria-label="Candidate video feed"></video>
        <canvas #hiddenCanvas style="display: none;"></canvas>
        <div class="gaze-overlay" [ngClass]="{'show': showGazeOverlay}" aria-hidden="true">
          <mat-icon>eye_with_line</mat-icon> Focused
        </div>
      </div>
      <div class="media-controls">
        <button mat-flat-button class="end-session-button" color="warn" (click)="endInterview()" aria-label="End interview session">
          <mat-icon>exit_to_app</mat-icon> End Session
        </button>
      </div>
      <div class="progress-section">
        <h3><mat-icon>insights</mat-icon> Interview Progress</h3>
        <p>Overall Progress: {{ currentQuestionIndex + 1 }} / {{ allQuestions.length }}</p>
        <p class="timer-display"><mat-icon>timer</mat-icon> Time Elapsed: {{ interviewTimer | date:'mm:ss' }}</p>
      </div>
      <div class="reliability-parameters">
        <h4><mat-icon>security</mat-icon> Reliability Metrics</h4>
        <mat-chip-listbox aria-label="Reliability metrics">
          <mat-chip color="warn" selectable="true" [ngClass]="{'animated-pulse': gazeWarnings > 0}">
            <mat-icon>remove_red_eye</mat-icon> Gaze Away: {{ gazeWarnings }} times
          </mat-chip>
          <mat-chip color="warn" selectable="true" [ngClass]="{'animated-pulse': tabSwitchCount > 0}">
            <mat-icon>tab</mat-icon> Tab Switches: {{ tabWarnings }}
          </mat-chip>
          <mat-chip color="warn" selectable="true" [ngClass]="{'animated-pulse': outOfWindowFocusCount > 0}">
            <mat-icon>call_split</mat-icon> Window Focus Lost: {{ outOfWindowFocusCount }}
          </mat-chip>
          <mat-chip color="accent" selectable="true" [ngClass]="{'animated-pulse': silenceWarning}">
            <mat-icon>volume_off</mat-icon> Prolonged Silence: {{ silenceWarning }}
          </mat-chip>
          <mat-chip color="primary" selectable="true">
            <mat-icon>mic_off</mat-icon> Audio Dropouts: {{ audioInputLostCount }}
          </mat-chip>
          <mat-chip color="primary" selectable="true">
            <mat-icon>videocam_off</mat-icon> Video Dropouts: {{ videoInputLostCount }}
          </mat-chip>
        </mat-chip-listbox>
      </div>
    </div>
  </div>

  <div class="global-warning-overlay" *ngIf="showGlobalWarning" role="alert" aria-live="assertive">
    <mat-icon class="warning-icon">error_outline</mat-icon>
    <p class="warning-text">{{ globalWarningMessage }}</p>
    <button mat-icon-button (click)="dismissGlobalWarning()" aria-label="Dismiss warning">
      <mat-icon>close</mat-icon>
    </button>
  </div>
</body>
</html>
